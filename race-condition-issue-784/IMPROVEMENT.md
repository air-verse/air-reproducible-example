# æ”¹è¿›è¯´æ˜

## ä¿®æ”¹å†…å®¹

æˆ‘ä¿®æ”¹äº†æµ‹è¯•è„šæœ¬ï¼Œè®© **Build A å’Œ Build B éƒ½ä¿®æ”¹ helper.go çš„ç‰ˆæœ¬å·**ï¼Œè¿™æ ·å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°æœ€ç»ˆè¿è¡Œçš„æ˜¯å“ªä¸ªæ„å»ºçš„ä»£ç ã€‚

### ä¿®æ”¹å‰çš„è¡Œä¸º

- **Build A**: åªä¿®æ”¹ `main.go`ï¼ˆæ·»åŠ æ³¨é‡Šï¼‰ï¼Œhelper ç‰ˆæœ¬ä¿æŒ `v1.0.0`
- **Build B**: ä¿®æ”¹ `helper.go` ç‰ˆæœ¬ä¸º `v2.0.0-BUILD-B`
- **é—®é¢˜**: å¦‚æœ Build A å®Œæˆï¼Œç‰ˆæœ¬ä»ç„¶æ˜¯ `v1.0.0`ï¼Œä¸å¤Ÿæ˜ç¡®

### ä¿®æ”¹åçš„è¡Œä¸º

- **Build A**: ä¿®æ”¹ `main.go` + è®¾ç½® helper ç‰ˆæœ¬ä¸º `v1.0.0-BUILD-A` 
- **Build B**: ä¿®æ”¹ helper ç‰ˆæœ¬ä¸º `v2.0.0-BUILD-B`
- **ä¼˜åŠ¿**: å¯ä»¥æ˜ç¡®åŒºåˆ†å“ªä¸ªæ„å»ºæœ€ç»ˆè¿è¡Œäº†

## å¦‚ä½•åˆ¤æ–­ Bug

é€šè¿‡ `curl http://localhost:8080/version` æŸ¥çœ‹ Helper Versionï¼š

### ğŸ› Bug å­˜åœ¨ï¼ˆç«æ€æ¡ä»¶ï¼‰

```
Helper Version: v1.0.0-BUILD-A
```

è¯´æ˜ï¼š
- Build A å®Œæˆå¹¶è¿è¡Œäº†
- Build B è¢«å–æ¶ˆäº†ï¼ˆè‡ªå·±å–æ¶ˆäº†è‡ªå·±ï¼‰
- æœ€æ–°çš„ä»£ç ä¿®æ”¹ï¼ˆBuild Bï¼‰æ²¡æœ‰ç”Ÿæ•ˆ

### âœ… Bug ä¸å­˜åœ¨ï¼ˆæ­£å¸¸è¡Œä¸ºï¼‰

```
Helper Version: v2.0.0-BUILD-B
```

è¯´æ˜ï¼š
- Build B æ­£å¸¸å®Œæˆå¹¶è¿è¡Œäº†
- æœ€æ–°çš„ä»£ç ä¿®æ”¹ç”Ÿæ•ˆäº†
- æ²¡æœ‰ç«æ€æ¡ä»¶

## æµ‹è¯•è„šæœ¬

### 1. `simple-test.sh` (æ–°å¢)

æœ€ç®€å•çš„æµ‹è¯•è„šæœ¬ï¼Œæ­¥éª¤æ¸…æ™°ï¼š

```bash
cd race-condition-issue-784
# ç»ˆç«¯ 1: å¯åŠ¨ air
air

# ç»ˆç«¯ 2: è¿è¡Œæµ‹è¯•
./simple-test.sh
```

è¾“å‡ºç¤ºä¾‹ï¼ˆBug å­˜åœ¨æ—¶ï¼‰ï¼š
```
Step 1: Triggering Build A...
  âœ“ Build A triggered at 22:30:15
  
Step 2: Triggering Build B...
  âœ“ Build B triggered at 22:30:17
  
RESULTS:
  Build A triggered: 22:30:15 (version: v1.0.0-BUILD-A)
  Build B triggered: 22:30:17 (version: v2.0.0-BUILD-B)
  Server running:    v1.0.0-BUILD-A

ğŸ› BUG DETECTED!
  â†’ Server is running Build A (OLD code)
  â†’ Build B was cancelled by the race condition
```

### 2. `trigger-race.sh` (å·²æ›´æ–°)

æ‰‹åŠ¨è¾…åŠ©è§¦å‘è„šæœ¬ï¼Œé…åˆæ‰‹åŠ¨å¯åŠ¨çš„ air ä½¿ç”¨ï¼Œå¯ä»¥çœ‹åˆ°å®Œæ•´çš„ air æ—¥å¿—ã€‚

### 3. `reproduce-auto.sh` (å·²æ›´æ–°)

å…¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼Œè‡ªåŠ¨å¯åŠ¨ airã€è§¦å‘æ„å»ºã€åˆ†æç»“æœã€‚

## ä¸ºä»€ä¹ˆè¿™æ ·æ›´å¥½ï¼Ÿ

1. **æ¸…æ™°åº¦**: ä¸€çœ¼å°±èƒ½çœ‹å‡ºè¿è¡Œçš„æ˜¯å“ªä¸ªç‰ˆæœ¬
2. **å¯è¿½æº¯**: ç‰ˆæœ¬å·åŒ…å« BUILD-A æˆ– BUILD-Bï¼Œä¸ä¼šæ··æ·†
3. **å‡†ç¡®æ€§**: ä¸éœ€è¦æ¯”è¾ƒæ—¶é—´æˆ³ï¼Œç›´æ¥çœ‹ç‰ˆæœ¬å­—ç¬¦ä¸²å³å¯
4. **æ˜“è°ƒè¯•**: å¦‚æœçœ‹åˆ° BUILD-Aï¼Œç«‹åˆ»çŸ¥é“ Build B è¢«å–æ¶ˆäº†

## åŸæ—¥å¿—åˆ†æ

ä½ æä¾›çš„æ—¥å¿— `air-reproduce.log` æ˜¾ç¤ºï¼š

```
22:27:35 - main.go changed â†’ Build A starts
22:27:37 - helper.go changed â†’ Should trigger Build B
22:27:46 - Build A completes
22:27:51 - Server shows: Build Time: 22:27:35.881
```

**é—®é¢˜**: 
- helper.go åœ¨ 22:27:37 æ”¹å˜äº†
- ä½†æ²¡æœ‰çœ‹åˆ°æ–°çš„ "Build started" æ¶ˆæ¯
- æœ€ç»ˆè¿è¡Œçš„æ˜¯ Build A çš„ä»£ç 

**ç»“è®º**: Build B è¢«ç«æ€æ¡ä»¶å–æ¶ˆäº†ï¼Œè¿™å°±æ˜¯ Bug #784ï¼

ç°åœ¨ä½¿ç”¨æ”¹è¿›åçš„è„šæœ¬ï¼Œä¼šæ›´æ¸…æ¥šåœ°çœ‹åˆ°ï¼š`Helper Version: v1.0.0-BUILD-A`ï¼ˆè€Œä¸æ˜¯æœŸæœ›çš„ `v2.0.0-BUILD-B`ï¼‰ã€‚
